#!/usr/bin/env bash

set -eu

QIIME_CONFIG_FP="$(readlink -f data/qiime_config)"
rm ~/.qiime_config
cp "${QIIME_CONFIG_FP}" ~/.qiime_config

# manually mung old file NZGL output with python
src/py/rename_demuxed_reads.py

# check the resulting mapping file
validate_mapping_file.py \
    -m output/qiime/split_libraries/mapping.txt \
    -o output/qiime/validate_mapping \
    --disable_primer_check

# run qiime
pick_open_reference_otus.py \
    --parallel \
    --jobs_to_start 20 \
    -i output/qiime/split_libraries/seqs.fna \
    -r output/fa/rbcl_58024.fa \
    -o output/qiime/open_references

# convert biom table for R
biom convert \
    -i output/qiime/open_references/otu_table_mc2_w_tax.biom \
    -o output/qiime/open_references/otu_table_mc2_w_tax.txt \
    --to-tsv --header-key taxonomy


biom summarize-table \
    -i output/qiime/open_references/otu_table_mc2.biom \
    -o output/qiime/open_references/otu_table_mc2.summary.txt

summarize_taxa_through_plots.py \
    -i output/qiime/open_references/otu_table_mc2.biom \
    -m output/qiime/validate_mapping/test_mapping.tab_corrected.txt \
    -o output/qiime/summarize_taxa 

core_diversity_analyses.py \
    -i output/qiime/open_references/otu_table_mc2.biom \
    -o output/qiime/core_diversity_analyses \
    -m output/qiime/validate_mapping/mapping_corrected.txt \
    -e 1 \
    --nonphylogenetic_diversity


